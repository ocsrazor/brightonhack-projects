<html>
  <head>
    <meta charset="utf-8">
    <script src="http://codeorigin.jquery.com/jquery-1.10.2.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style type="text/css">
      body { font-family: Verdana; color: #666; background: #666 }
      div { padding: 5px; }
      h1 { color: #ccc }
    /* slider style */
    .axis {
      font: 10px sans-serif;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    .axis .domain {
      fill: none;
      stroke: #000;
      stroke-opacity: .3;
      stroke-width: 10px;
      stroke-linecap: round;
    }

    .axis .halo {
      fill: none;
      stroke: #ddd;
      stroke-width: 8px;
      stroke-linecap: round;
    }

    .slider .handle {
      fill: #fff;
      stroke: #000;
      stroke-opacity: .5;
      stroke-width: 1.25px;
      pointer-events: none;
    }

    .timescale {
      fill: none;
      stroke: #000;
      stroke-opacity: .5;
      stroke-width: 1.25px;
      border: 1px dotted #ccc;
    }

    .timescale .time {
      fill: #aaa;
      opacity: 0.4;
    }

    .moneyometer {
      fill: none;
      stroke: #000;
      stroke-opacity: .5;
      stroke-width: 1px;
      border: 1px dotted #ccc;
    }

    .moneyometer .money {
      fill: #0033cc;
      opacity: 0.4;
    }
    </style>
  </head>
  <body>
    <div id="mapdiv" style="width: 400px; height: 700px; float: left">
      <h1>Where in the UK</h1>
    </div>
    <div id="moneyandpump" style ="width: 300px; height: 700px; float: left">
      <h1>Quantitive Ease</h1>
    </div>
    <div id="timeline" style = "width: 100%; height: 50px; float: left"></div>
    <div style="clear: both" id="leappos">0</div>
    <textarea id="debug" rows="10" cols="60" style="background: #999"></textarea>

    <script src="http://js.leapmotion.com/0.2.0/leap.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>

    <script type="text/javascript">
            
        /*
          TODO:
          
          Setup stage - use % widths for divs on the page (perhaps with a sensible minmum ?)
          
          Calculate widths of those divs to esatblish intial size for SVG stage
          
          When the timeline is initialised set the sizes of the bottom 10% and the top 1% (images of flat cap + bowler hat)
          A circle motion with a single finger is caught by Leap and the timeline goes forward by, say, 3 months (or 1 year if data does not allow)
          
          Then we reach the crash time... (date stored in global var)
          A new gesture detected to start automatic timeline forward to the beginning of QE (e.g. 3 months every second... ? )
          
          Now show the moneyometer... 
          Finally we "pump" money into the economy (QE) using the Leap pump action and move the timeline forward as much as the downward motion allows 
            (i.e. no "threshold", but continuous motion by storing the last position of 2 palms and testing for downward motion)
          
        */
        
        var scale = d3.scale.linear().domain([19000, 40000]).range(['#fc0', '#f00']);

        //Width and height
        var w = 400;
        var h = 600;

        //Define map projection
        // var projection = d3.geo.mercator()
        //                  .translate([w/2, h/2])
        //                  .scale([800]);

       var projection = d3.geo.mercator()
           .scale(2000)
           .translate([300,2600])
           .precision(.1);

        //Define path generator
        var path = d3.geo.path()
                    .projection(projection);

        //Create SVG element
        var svg = d3.select("#mapdiv")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);

        var map;
        var all_data;

        // LOAD IN MONEY DATA
        d3.json("region_data.json", function(d){

          all_data = d;

          //Load in GeoJSON data
          d3.json("regions.json", function(json) {

            //Bind data and create one path per GeoJSON feature
             map = svg.selectAll("path")
               .data(json.features)
               .enter()
               .append("path")
               .attr("d", function(d){
                 return path(d.geometry)
               })
               .style('fill', '#ccc');
              colourRegions(2005, 'mean');
          });
        });

        function colourRegions(year, field) {
          var data = all_data[year];
          if (!data) return false;
          var min=99999999999999999, max=0;
          var keys = Object.keys(data);
          for (i=0; i<keys.length; i++) {
            var n = keys[i];
            var v = data[n]['total'][field];
            if (v && v < min) min = v;
            if (v && v > max) max = v;
          }
          scale = d3.scale.linear().domain([min, 40000]).range(['#FFEE00', '#FF0000']);
          var svg = d3.select('svg');
          svg.selectAll('path')
            .transition()
            .duration(1200)
            .style("fill", function(d, i) {
              var n = d.properties.name;
              // console.log(n);
              if (data[n]) {
                // console.log(data[n]);
                var v = data[n]['total'][field];
                return scale(v);
              } else {
                // console.log('  not found');
                return '#ccc';
              }
          });
        }

        // MONEYOMETER
        
        /*
        TODO : 
          create object for these variables... QE ?
          calulate (and round up to nearest 50) the diff between the largest value from csv data and the smallest.
            and set max_money
          set first and last dates for QE based on csv
            
          create function call to setup and display moneyometer.... (when timeline reaches QE.first)
          
          
        */
        var easing_by_date = {};
        
        d3.csv('quantitive_easing.csv', function(rows) { 
          for(i=0; i<=rows.length; i++) {
            if (rows[i]) {
              if (rows[i].date) easing_by_date[rows[i].date]=+rows[i].total;
            }
          }
        });

        var total_height = 600;

        var moneyometer_dimensions = {
          margin_top: 10,
          margin_bottom: 0,
          margin_left: 10,
          width: 80,
          height: 580,
          max_money: 350
        }

        var money_scale = d3.scale.linear()
             .domain([moneyometer_dimensions.max_money, 0])
             .range([0, moneyometer_dimensions.height]);

        var moneyometer = d3.select('#moneyandpump').append('svg')
            .attr('width', moneyometer_dimensions.width)
            .attr('height', moneyometer_dimensions.height)
            .attr('class', 'moneyometer')
            .call(d3.svg.axis()
              .scale(money_scale)
              .orient("right")
              .tickFormat(function(d) { return (d > 0) ? "Â£" + d + "B" : ""; })
              .tickSize(10)
              .tickPadding(12));

        var money = moneyometer.append('rect')
          .attr('class', 'money')
          .attr('width', moneyometer_dimensions.width)
          .attr('height', 0)
          .attr('transform', "translate(0," + moneyometer_dimensions.height + ")");

        function setMoney(amount) {
          if (amount > moneyometer_dimensions.max_money) amount = moneyometer_dimensions.max_money;
          var h = money_scale(moneyometer_dimensions.max_money - amount);
          var y_offset = moneyometer_dimensions.height - h;
          money
            .transition()
            .duration(400)
            .attr('height', h)
            .attr('transform', "translate(0," + y_offset + ")");

        }

        // TIMESCALE
        // TODO: use the right hand side of the screen to fit in the images of the 2 men and tie the data to the wealth gap data (to come!)
        
        

        var timescale_dimensions = {
          margin_top: 20,
          margin_bottom: 0,
          margin_left: 20,
          width: 1000,
          height: 50
        }

        var time_span = {
          from: new Date('2005-01-01'),
          to: new Date('2013-03-25'),
          crash_start: new Date('2008-09-01'),
          qe_start: new Date('2009-03-11')
        }
        var time_scale = d3.time.scale()
             .domain([time_span.from, time_span.to])
             .rangeRound([0, timescale_dimensions.width]);

        var time_axis = d3.svg.axis()
              .scale(time_scale)
              .orient("down")
              .ticks(d3.time.month, 12)
              .tickFormat(d3.time.format('%b %y'))
              .tickSize(10)
              .tickPadding(5);

        var timeline = d3.select('#timeline').append('svg')
            .attr('width', timescale_dimensions.width)
            .attr('height', timescale_dimensions.height)
            .attr('class', 'timescale')
            .call(time_axis);

        var time = timeline.append('rect')
          .attr('class', 'time')
          .attr('height', timescale_dimensions.height)
          .attr('width', 0)
          .attr('transform', "translate(0,0)");


        var qe_offset = time_scale(time_span.qe_start);
        // var time_to_money_scale = d3.scale.linear().domain([qe_offset,timescale_dimensions.width]).range([0,moneyometer_dimensions.max_money]);

        function updateTimeline(val) {
          
          if ( val > timescale_dimensions.width) return false;

          var date = time_scale.invert(val);
          colourRegions(date.getFullYear(), 'mean');
          
          time
            .transition()
            .duration(800)
            .attr('width', val);

          if (date >= time_span.qe_start) {
            var d = date.toISOString().substring(0,10);
            var m = easing_by_date[d];
            if (m) setMoney(m);
          }
        }

        // PUMP

        var leapFrame;

        // var pump_dimensions = {
        //   height: 200
        // };
        // var pump_scale = d3.scale.linear().domain([0,100]).range([0,pump_dimensions.height]);

        var pump = {
          position: 0,
          value: qe_offset,
          max: timescale_dimensions.width,
          num_pumps: 20,
          distance: 500
        };
        
        pump['timechange_per_pump'] = (pump.max - pump.value) / pump.num_pumps

        function updatePump(pos) {
          var last_pos = pump.position;
          pump.position = pos;
          if (pos < last_pos) {
            var diff = last_pos - pos;            
            
            
          }
          if (pump.down) {
            if (pos > pump.up_threshold) {
              pump.down = false;
              // pumpUpTheVolume();
            }
          } else {
            if (pos < pump.down_threshold) {
              pump.down = true;
              pumpUpTheVolume();
            }
          }
        }

        var time_to_width_ratio = (timescale_dimensions.width - qe_offset) / 24;

        function pumpUpTheVolume() {
          pump.value += 1;
          // setMoney(pump.value * 20);
          updateTimeline(qe_offset + (pump.value * time_to_width_ratio));
        }
        
        Leap.loop(function(frame){
          leapFrame=frame;
          if (leapFrame) { // not a programmatic event
            if(leapFrame.hands.length == 2){
              var pos = frame.hands[0].palmPosition[1];
              updatePump(pos);
              $('#leappos').html(pos);
            }
            if (leapFrame.gestures.length > 0) {
              console.log(leapFrame.gestures);
            }
          }
        });
      </script>

    </body>
  </body>
</html>

